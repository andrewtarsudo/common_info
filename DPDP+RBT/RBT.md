# **RBT - Ring back tone**
## Расписание
Schedule - объект, для которого задается график выполнения с определенным интервалом:
- На конкретное время суток дня
- На конкретный день недели
- На конкретный день месяца

Расписание может иметь конкретную дату и время начала и конца. По умолчанию оно бесконечно
Используются в правилах проигрывания

## Правило проигрывания
Правило проигрывания (Rule) - сущность, которая позволяет настроить правила проигрывания контента в зависимости от того кто звонит абоненту и когда. Для RBT и Anti-RBT задаются свои независимые правила.
Так как услуга Anti-RBT всегда более приоритетна чем RBT, то Anti-RBT правила проигрывания имеют всегда приоритет выше чем RBT правила.
Параметры:
- Schedule - позволяет настраивать время и/или дату проигрывания контента. К одному правилу можно прикрепить одно или несколько расписаний. По умолчанию всегда (any time)
- Content - к одному правилу можно прикрепить один или несколько контентов (мелодий и плейлистов). При проигрывании плейлисты будут разбираться на тоны. По умолчанию все купленные мелодии
- Mode - режим проигрывания. Рандомно или по порядку. Имеет смысл только если у правила несколько контентов. По умолчанию random
- Caller - абоненты или группы абонентов для которых следует играть правило. По умолчанию любые абоненты
- Order - приоритет правила. Чем он выше, тем правило будет обрабатываться приоритетнее

#### Технически
*Base*
Каждый абонент имеет по умолчанию дефолтное правило. Его нельзя удалить. Он имеет order = 0 (самый низкий приоритет) и его нельзя поменять. Дефолтное правило играет для всех и всегда (caller = all, schedule = any time). Для него можно настроить только content (если купленного контента нет то будет играть дефолтная системная мелодия) и mode.
Был выбран гибкий подход, который позволяет делать правила с любыми параметрами и самому абоненту выставлять приоритет каждого правила (на основе order).

*Telenor*
Заказчик пожелал иметь определенные типы правил с заранее оговоренными приоритетами проигрывания. Таким образом был введен тип правила (rule type):
- Caller rule - правило для которого можно задать только одного абонента (caller) и content (один или несколько). Schedule задать нельзя. Правила с таким типом имеет наивысший приоритет
- Caller group rule - Тоже что и Caller rule, но вместо одного абонента можно задать только одну группу абонентов. Приоритет ниже чем у Caller rule
- Schedule rule - правило для которого можно задать только schedule (одно или несколько) и content (один или несколько). Абонентов задать нельзя. Приоритет ниже чем у Caller group rule

Дефолтное правило так же имеется и оно идентично базовой версии.
Для того чтобы не рушить логику с гибкими ордерами (order) был выбран подход который бы давал разрешенный диапазон ордеров для каждого из типов. Для Schedule rule - 10000 .. 20000, для Caller group rule - 20001 .. 30000 и т.д. При создании Caller group rule ордер у него будет всегда в диапазоне 20001 .. 30000, таким образом достигается жестко заданный приоритет типов.
Для правил Caller group rule и Schedule rule по-прежнему осталось возможность абонентом менять ордер правила, но только в рамках диапазона ордеров своего типа

## Member
Абонент, который находится в телефонной книге у другого абонента. Мембер может быть создан явно абонентом при добавлении его в группу абонентов. Либо неявно, например когда абонент указывает новый номер в правиле проигрывания и сохраняет это правило

## Группа абонентов (Caller group)
Мемберы объединенные в группу.
По умолчанию для каждого абонента создаются следующие специальные группы, их нельзя удалить:
- Favorite - была сделана лишь для удобства
- Blacklist - абоненты в черном списке. Для таких абонентов в случае с Anti-RBT услугой будут игнорироваться любые Anti-RBT правила, в случае с RBT - любые RBT правила. Так, например: если у абонента А включена услуга Anti-RBT, у него есть Anti-RBT правило для абонента Б и при этом абонент Б находится у него в черном списке, то при звонке А -> Б Anti-RBT правило будет проигнорировано и в ход вступят RBT правила абонента Б (если таковые имеются)
- Corportate - абоненты для которых настраиваются правила проигрывания корпоративным юзером

Дополнительно абонент может создать свои пользовательские (GENERAL) группы в любом объеме и использовать их
